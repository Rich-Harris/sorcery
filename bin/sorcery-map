#!/usr/bin/env node

var path = require( 'path' );
var minimist = require( 'minimist' );
var fse = require( 'fs-extra' );
var globby = require( 'globby' );
var showHelp = require( './showHelp' );
var command;
var sorcery_map = require( '../' );

command = minimist( process.argv.slice( 2 ), {
	alias: {
		i: 'input',
		o: 'output',
		v: 'version',
		h: 'help',
		d: 'datauri',
		x: 'excludeContent',
		e: 'existingContentOnly'
	}
});

if ( command.help ) {
	showHelp( process.stdout );
}

else if ( process.argv.length <= 2 && process.stdin.isTTY ) {
	showHelp( process.stderr );
}

else if ( command.version ) {
	console.log( 'Sorcery-map version ' + require( '../package.json' ).version );
}

else if ( !command.input ) {
	console.error( 'Error: You must supply an --input (-i) argument. Type sorcery --help for more info' );
}

else {
	fse.stat( command.input ).then( function ( stats ) {
		if ( stats.isDirectory() ) {
			const globby_options = {
				cwd: command.input
			}
			globby("**/*.js", globby_options)
			.then((files) => {
				return files.reduce( function ( promise, file ) {
					return promise.then( function () {
						var input = path.join( command.input, file );
						var output = path.join( command.output || command.input, file );

						return sorcery_map.load( input, options ).then( function ( chain ) {
							return chain.write( output, {
								inline: command.datauri,
								includeContent: !command.excludeContent
							});
						});
					});
				}, Promise.resolve() );
			});
		}

		return sorcery_map.load( command.input, command ).then( function ( chain ) {
			return chain.write( command.output || command.input, {
				inline: command.datauri,
				includeContent: !command.excludeContent
			});
		});
	}).catch( function ( err ) {
		setTimeout( function () {
			throw err;
		});
	});
}
